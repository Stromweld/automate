daemon off;

worker_processes 4;

error_log stderr error;

events {
  worker_connections 1024;
}

http {
  include        /app/config/mime.types;
  default_type   application/octet-stream;

  sendfile       on;
  tcp_nopush     on;
  tcp_nodelay    on;

  keepalive_timeout 60;

  gzip on;
  gzip_vary on;
  gzip_min_length 10240;
  gzip_proxied expired no-cache no-store private auth;
  gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;
  gzip_disable "MSIE [1-6]\.";

  client_body_buffer_size 16k;
  server_tokens off;

  client_body_temp_path /app/var/client-body;
  fastcgi_temp_path /app/var/fastcgi;
  proxy_temp_path /app/var/proxy;
  scgi_temp_path /app/var/scgi_temp_path;
  uwsgi_temp_path /app/var/uwsgi;

  log_format chef '$remote_user [$time_local]  '
                  '"$request" $status "$request_time" $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" "$upstream_addr" "$upstream_status" "$upstream_response_time" $request_length';

  access_log /dev/stdout chef;

  server {
    listen 127.0.0.1:10161 ssl;

    ssl_certificate /app/certs/service.crt;
    ssl_certificate_key /app/certs/service.key;
    ssl_client_certificate /app/certs/root_ca.crt;
    ssl_verify_client off;
    ssl_verify_depth 1;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:!aNULL:!eNULL:!EXPORT;
    ssl_prefer_server_ciphers on;

    location /custom_settings.js {
      add_header Cache-Control "private, no-cache, no-store";
      alias /app/config/custom_settings.js;
      break;
    }

    root /app/dist;
    location / {
      try_files $uri $uri/ /;
      add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    }
  }
}
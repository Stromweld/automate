# Chef Automate Backup from Embedded PostgreSQL/OpenSearch and restore to External AWS PostgreSQL/OpenSearch

Following document provides the following information:
- Steps to switchover from chef automate embedded PostgreSQL/OpenSearch services to external AWS PostgreSQL and OpenSearch service. 
- Steps to take backup from chef automate embedded PostgreSQL/OpenSearch services and restore it to External AWS PostgreSQL and OpenSearch service.


The following stpes assumes that you already have Chef Automate setup running with embedded PostgreSQL/OpenSearch services and S3 backup configuration.

Before switcing to external AWS RDS/OS services, please take s3 backup by following below steps:


## Create a Backup

Make a backup with the [`backup create`]({{< ref "cli_chef_automate/#chef-automate-backup-create" >}}) command:

```shell
chef-automate backup create
```

The output shows the backup progress for each service.
A successful backup displays a success message containing the timestamp of the backup:

```shell
Success: Created backup 20180518010336
```

### List Backups

You can list existing backups with the [`backup list`]({{< ref "cli_chef_automate/#chef-automate-backup-list" >}}) command:

```shell
chef-automate backup list
```

The output shows each backup and its age:

```shell
        Backup        State  Age
20180508201548    completed  8 minutes old
20180508201643    completed  8 minutes old
20180508201952    completed  4 minutes old
```

By default, this command communicates with your running Chef Automate installation to list the backups.
If the Chef Automate installation is down, you can still list the backups.

For backups stored in an AWS S3 bucket, use:

```shell
chef-automate backup list s3://bucket_name/base_path
```

where `bucket_name` is the name of the S3 bucket and `base_path` is an optional path within the bucket where the backups live.


In next steps we will configure Chef AUtomate to run with external AWS RDS/OS services:


## Configuring External PostgreSQL Database

These configuration directions are intended for in the initial deployment of Chef Automate.

Create `postgresql.toml` file and add following details of your AWS PostgreSQL RDS:

```toml
[global.v1.external.postgresql]
enable = true
nodes = ["<pghostname1>:<port1>", "<pghostname2>:<port2>", "..."]

# To use postgres with SSL, change enable to true and uncomment root_cert:
[global.v1.external.postgresql.ssl]
enable = false
# root_cert = """$(cat </path/to/root/cert.pem>)"""

[global.v1.external.postgresql.auth]
scheme = "password"

# Create these postgres users before starting the Automate deployment;
# Automate assumes they already exist.
[global.v1.external.postgresql.auth.password.superuser]
username = "<admin username>"
password = "<admin password>"
[global.v1.external.postgresql.auth.password.dbuser]
username = "<dbuser username>"
password = "<dbuser password>"

[global.v1.external.postgresql.backup]
enable = true
```

Run the following command to apply your configuration:

```shell
chef-automate config patch postgresql.toml
```

Verify whether all services are running:

```sh
chef-automate status
```

Verify if the Chef Automate is running with external Opensearch by ruuning below command:

```sh
chef-automate config show
```


## Configure External Opensearch

These configuration directions are intended for External AWS managed OpensSearch service.

Create `opensearch.toml` file and add following information of your AWS OpenSearch:


```toml
[global.v1.external.opensearch]
enable = true
nodes = ["https://<domain>.<region>.es.amazonaws.com"]

# fill out if using external aws opensearch service with SSL and aws_os auth
[global.v1.external.opensearch.auth]
scheme = "aws_os"
[global.v1.external.opensearch.auth.aws_os]
## Create this opensearch user and IAM user before starting the Automate deployment;
## Automate assumes it exists.
username = "<admin username>"
password =  "<admin password>"
## credentials (required) for IAM user created for s3 backup/restore as mentioned in setup
access_key = "<access key>"
secret_key = "<secret key>"
[global.v1.external.opensearch.ssl]
## Specify either a root_cert or a root_cert_file
root_cert = """$(cat </path/to/cert_file.crt>)"""

# For S3 backups add the following section in config.toml or can be patched later
[global.v1.external.opensearch.backup]
enable = true
location = "s3"
[global.v1.external.opensearch.backup.s3]
## bucket (required): The name of the bucket
bucket = "<bucket name>"
## base_path (optional):  The path within the bucket where backups should be stored
## If base_path is not set, backups will be stored at the root of the bucket.
base_path = "<base path>"
client = "default"
[global.v1.external.opensearch.backup.s3.settings]
region = "<bucket region>"
## IAM role ARN (required) to access s3 for backup/restore i.e. TheSnapshotRole
role_arn = "<IAM role ARN to access s3 for backup/restore i.e. TheSnapshotRole>"
```

Run the following command to apply your configuration:

```shell
chef-automate config patch opensearch.toml
```

Verify whether all services are running:

```sh
chef-automate status
```

Verify if the Chef Automate is running with external Opensearch by ruuning below command:

```sh
chef-automate config show
```

### Registering Snapshot Repository

To register a snapshot repository, send a PUT request to the OpenSearch Service domain endpoint. You can't use curl to perform this operation because it doesn't support AWS request signing. Instead, use the [sample Python client](https://docs.aws.amazon.com/opensearch-service/latest/developerguide/managedomains-snapshots.html#managedomains-snapshot-client-python), Postman, or some other method to send a signed request to register the snapshot repository.

Make sure to follow steps mentioned while setting up amazon opensearch domin. Use the same role_arn and IAM user credentials mapped to manage_snapshots role on opensearch dhashoboards

While using postman to send below request, Under Authorization select type `AWS Signature` and fill AccessKey, SecretKey, AWS Region and Service Name as `es`

The request takes the following format:

```shell
PUT domain-endpoint/_snapshot/<snapshot-repo-name>
{
  "type": "s3",
  "settings": {
    "bucket": "s3-bucket-name",
    "base_path": "elasticsearch/<snapshot-repo-name>",
    "region": "<region>",
    "role_arn": "arn:aws:iam::123456789012:role/TheSnapshotRole" 
  }
}
```

Register following repositories by replacing `<snapshot-repo-name>` in above request sample and send request for each of following repositories:

```
chef-automate-es5-automate-cs-oc-erchef
chef-automate-es5-compliance-service
chef-automate-es5-event-feed-service
chef-automate-es5-ingest-service
chef-automate-es6-automate-cs-oc-erchef
chef-automate-es6-compliance-service
chef-automate-es6-event-feed-service
chef-automate-es6-ingest-service
```

If your domain resides within a virtual private cloud (VPC), your computer must be connected to the VPC for the request to successfully register the snapshot repository. Accessing a VPC varies by network configuration, but likely involves connecting to a VPN or corporate network. To check that you can reach the OpenSearch Service domain, navigate to https://your-vpc-domain.region.es.amazonaws.com in a web browser and verify that you receive the default JSON response.



Take backup of chef automate updated config with details of external PostgreSQL/Opensearch to new file like `full_config.toml` by running below command:

```sh
chef-automate config show > full_config.toml
```


## Restore From an AWS S3 Backup

Meet the required [prerequisites]({{< ref "restore.md#prerequisites" >}}) before beginning your restore process.

See how to [back up to AWS S3]({{< ref "backup/#backup-to-aws-s3" >}}). 

Pass s3 access key and s3 secret key to restore command.

Use the `--patch-config` option with a new updated config `full_config.toml` to restore data to external PostgreSQL/Opensearch:

To restore from an AWS S3 bucket backup on a new host, run:

```shell
chef-automate backup restore s3://bucket_name/path/to/backups/BACKUP_ID --patch-config full_config.toml --s3-access-key <access_key> --s3-secret-key <secret_key>
```

To restore from an AWS S3 bucket backup on an existing Chef Automate host, run:

```shell
chef-automate backup restore s3://bucket_name/path/to/backups/BACKUP_ID --skip-preflight --patch-config full_config.toml --s3-access-key "Access_Key"  --s3-secret-key "Secret_Key"
```


A successful restore shows the timestamp of the backup used at the end of the status output:

```shell
Success: Restored backup 20180517223558
```

{{< note >}} `automate-opensearch`  and  `automate-postgresql` services comes up for short time while running restore operation but they will get deactivated after restore is successful and data will be restore on external managed RDS/ Amazon RDS. {{< /note >}}




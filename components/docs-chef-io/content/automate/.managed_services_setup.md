## Prerequisite

### PostgreSQL Setup

- Setup PostgreSQL RDS DB instance in AWS. Please refer the following documentation link to create it:
  [PostgreSQL RDS Setup](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_GettingStarted.CreatingConnecting.PostgreSQL.html)

- Before you attempt to connect to the DB instance, make sure that the DB instance is associated with a security group that provides access to it. Ensure External RDS is accessible from Automate instances.

### OpenSearch Setup

- Create an Opensearch domain. Please refer the following documentation link to create it:
  [Amazon OpenSearch Service domains Creation](https://docs.aws.amazon.com/opensearch-service/latest/developerguide/createupdatedomains.html)

Please make sure to follow below steps while creating domain:

- Please user version 1.2 and above.

- Under `Dedicated master nodes` section, do not opt for `Enable dedicated master nodes` and make it unchecked.

- Under `Fine-grained access control section`, select `Enable fine-grained access control` and only choose `create master user`. Add master username and master password for your master user.

- Under `Access policy` section, select `Configure domain level access policy`and modify the "Effect" from "Deny" to "Allow".

Following steps are required for opensearch s3 backup/restore:

- Create an IAM role with below two Permission policies. The rest of this chapter refers to this role as TheSnapshotRole.

  - AmazonS3FullAccess
  - In order to register the snapshot repository, you need to be able to pass TheSnapshotRole to OpenSearch Service. You also need access to the es:ESHttpPut action. To grant both of these permissions, attach the following policy to the IAM user or role whose credentials are being used to sign the request as shown in below example:

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "iam:PassRole",
        "Resource": "arn:aws:iam::123456789012:role/TheSnapshotRole" // ARN of IAM role i.e. TheSnapshotRole
      },
      {
        "Effect": "Allow",
        "Action": "es:ESHttpPut",
        "Resource": "arn:aws:es:region:123456789012:domain/domain-name/*" // ARN of opensearch domain
      }
    ]
  }
  ```

  - Edit the trust relationship of TheSnapshotRole to specify OpenSearch Service in the Principal statement as shown in the following example:

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Service": ["opensearchservice.amazonaws.com", "ec2.amazonaws.com"]
        },
        "Action": "sts:AssumeRole"
      }
    ]
  }
  ```

- Crete an IAM user and attach same above two permission policies which are added for TheSnapshotRole. Save the security credetials for this IAM user for S3 backup/restore.

- Map the snapshot role in OpenSearch Dashboards
  Fine-grained access control introduces an additional step when registering a repository. Even if you use HTTP basic authentication for all other purposes, you need to map the manage_snapshots role to your IAM user or role that has iam:PassRole permissions to pass TheSnapshotRole.
    1. Navigate to the OpenSearch Dashboards plugin for your OpenSearch Service domain. You can find the Dashboards endpoint on your domain dashboard on the OpenSearch Service console.
    2. From the main menu choose Security, Roles, and select the manage_snapshots role.
    3. Choose Mapped users, Manage mapping.
    4. Add the domain ARN of the user or role that has permissions to pass TheSnapshotRole. Put user ARNs under Users and role ARNs under Backend roles.

  ```
  arn:aws:iam::123456789123:user/user-name
  ```

  ```
  arn:aws:iam::123456789123:role/role-name
  ```

  5. Select Map and confirm the user and role shows up under Mapped users.

{{< note >}} To access the default installation of OpenSearch Dashboards for a domain that resides within a VPC, users must have access to the VPC. This process varies by network configuration, but likely involves connecting to a VPN or managed network or using a proxy server or transit gateway. Refer [Launching your Amazon OpenSearch Service domains within a VPC](https://docs.aws.amazon.com/opensearch-service/latest/developerguide/vpc.html#vpc-security)

From the terminal, run the following command:

```sh
ssh -i ~/.ssh/your-key.pem ec2-user@your-ec2-instance-public-ip -N -L 9200:vpc-domain-name.region.es.amazonaws.com:443
```
This command creates an SSH tunnel that forwards requests to https://localhost:9200 to your OpenSearch Service domain through the EC2 instance. Specifying port 9200 in the command simulates a local OpenSearch install, but use whichever port you'd like. OpenSearch Service only accepts connections over port 80 (HTTP) or 443 (HTTPS).

The command provides no feedback and runs indefinitely. To stop it, press Ctrl + C.

Navigate to https://localhost:9200/_dashboards/ in your web browser. You might need to acknowledge a security exception.

Alternately, you can send requests to https://localhost:9200 using curl, Postman, or your favorite programming language. {{< /note >}}